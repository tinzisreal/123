{% set menu = appbuilder.menu %}
{% set app_icon_width = appbuilder.app.config['APP_ICON_WIDTH'] %}
{% set logo_target_path = appbuilder.app.config['LOGO_TARGET_PATH'] or '/' %}
{% set root_path = logo_target_path if not logo_target_path.startswith('/') else '/superset' + logo_target_path if current_user.username is defined else '#' %}

{% block navbar %}
  <div id="app-menu">
    <div class="navbar navbar-static-top {{menu.extra_classes}}" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="{{ root_path }}">
            <img width="{{ app_icon_width }}" src="{{ appbuilder.app_icon }}" alt="{{ appbuilder.app_name }}"/>
          </a>
        </div>
        <ul class="nav navbar-nav navbar-right">
          {# ... c√°c m·ª•c Settings, Info, v.v ... #}
          <li>
            <a href="#" id="custom-logout">
              üö™ Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <script nonce="{{ csp_nonce() }}">
    document.addEventListener("DOMContentLoaded", function() {
      console.log("‚úÖ navbar.html JS loaded!");

      const logoutBtn = document.getElementById("custom-logout");
      console.log("üîç Found logoutBtn:", logoutBtn);

      if (logoutBtn) {
        logoutBtn.addEventListener("click", function(e) {
          e.preventDefault();
          console.log("üö™ Custom Logout clicked at:", new Date().toISOString());

          const w = 400, h = 300;
          const left = (screen.width - w) / 2;
          const top = (screen.height - h) / 2;

          const popupUrl = "/logout/";
          console.log("üì§ Opening popup to:", popupUrl);

          const popup = window.open(
            popupUrl,
            "SupersetLogout",
            `width=${w},height=${h},top=${top},left=${left}`
          );

          if (!popup) {
            console.warn("‚ö†Ô∏è Popup blocked by browser!");
            alert("Popup b·ªã ch·∫∑n, h√£y b·∫≠t popup cho site n√†y.");
            return;
          }

          console.log("‚úÖ Popup opened successfully");

          // auto ƒë√≥ng popup + reload l·∫°i
          setTimeout(() => {
            console.log("‚è≥ Closing popup + reloading page");
            if (!popup.closed) popup.close();
            window.location.href = "/login/";
          }, 800);
        });
      }
    });
  </script>
{% endblock %}
