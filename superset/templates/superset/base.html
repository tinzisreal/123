{% extends "appbuilder/baselayout.html" %}
{% from 'superset/partials/asset_bundle.html' import css_bundle, js_bundle with context %}

{% block head_css %}
  {{ super() }}
  {{ css_bundle("theme") }}
{% endblock %}

{% block head_js %}
  {{ super() }}
  {{ js_bundle("theme") }}
{% endblock %}

{% block tail_js %}
  {{ super() }}
  {{ js_bundle("preamble") }}
  {{ js_bundle("menu") }}
  {% include "tail_js_custom_extra.html" %}

  <script nonce="{{ csp_nonce() }}">
  document.addEventListener("DOMContentLoaded", function() {
    console.log("✅ base.html JS loaded!");

    // tìm tất cả link có /logout (có thể kèm query)
    const logoutLinks = document.querySelectorAll("a[href^='/logout']");
    console.log("Found logout links:", logoutLinks);

    logoutLinks.forEach(logoutLink => {
      // đổi nhãn nút (nếu muốn)
      logoutLink.textContent = "🚪 Logout Superset";

      // chặn click mặc định
      logoutLink.addEventListener("click", function(e) {
        e.preventDefault();
        console.log("🚪 Custom Logout clicked!");

        const w = 400, h = 300;
        const left = (screen.width - w) / 2;
        const top = (screen.height - h) / 2;

        const popup = window.open(
          logoutLink.getAttribute("href") || "/logout/",
          "SupersetLogout",
          `width=${w},height=${h},top=${top},left=${left}`
        );

        if (!popup) {
          alert("⚠️ Popup bị chặn, hãy bật popup cho site này.");
          return;
        }

        // auto đóng popup + reload lại
        setTimeout(() => {
          if (!popup.closed) popup.close();
          window.location.href = "/login/";
        }, 800);
      });
    });
  });
  </script>
{% endblock %}
